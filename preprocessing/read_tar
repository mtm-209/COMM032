from create_skew import *
import os
import tarfile
import time

import requests
from tqdm import tqdm


def get_val_from_tar(file_path):  # destination_dir):
    with tarfile.open(file_path, "r:gz") as tar:
        for member in tqdm(tar.getmembers()):
            if "/validated.tsv" in member.name:
                file = tar.extractfile(member)
                val_lst = target_data(file, skew='50-50')
                # print(member)#val_lst
                return val_lst


def copy_clips_folder(src, dst):
    with tarfile.open(src, "r:gz") as tar:
        clips_folder = None
        # files = None
        for member in tar.getmembers():
            if '/clips/' in member.name:
                clips_folder = os.path.dirname(member.name)
                break

        if not clips_folder:
            print("No 'clips' folder found in tar file")
            return

        desired_files = get_val_from_tar(src)
        members_to_extract = []

        for member in tqdm(tar.getmembers()):
            if member.name.startswith(clips_folder) and os.path.basename(member.name) in desired_files:
                members_to_extract.append(member)

        tqdm(tar.extractall(path='temp_dir',
                            members=members_to_extract))
        shutil.copytree(os.path.join('temp_dir', clips_folder), os.path.join(dst, 'clips'))
        shutil.rmtree('temp_dir')


# Test Inputs folders

test_input = r"C:\Users\matth\OneDrive\Documents\COMM032\datasets_zipped\cv-corpus-12.0-delta-2022-12-07-sv-SE.tar.gz"
portugal_test = r"C:\Users\matth\OneDrive\Documents\COMM032\datasets_zipped\cv-corpus-10.0-delta-2022-07-04-pt.tar.gz"
tar_file = r"C:\Users\matth\OneDrive\Documents\COMM032\datasets_zipped\cv-corpus-12.0-delta-2022-12-07-en.tar.gz"
swedish_file = r"C:\Users\matth\OneDrive\Documents\COMM032\datasets_zipped\cv-corpus-12.0-2022-12-07-sv-SE.tar.gz"
swedish_tsv = r"C:\Users\matth\OneDrive\Documents\COMM032\validated.tsv"

# Output dir
output_dir = r"C:\Users\matth\OneDrive\Documents\COMM032\datasets"

#copy_clips_folder(swedish_file, output_dir)
